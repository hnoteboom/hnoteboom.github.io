<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Ethics in Data Science – Harper Noteboom</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Harper Noteboom</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../article.html"> 
<span class="menu-text">Article</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../observable_1.html"> 
<span class="menu-text">Data Viz in JavaScript</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-data-viz-in-r" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Data Viz in R</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-data-viz-in-r">    
        <li>
    <a class="dropdown-item" href="../data-viz/bechdel-test.html">
 <span class="dropdown-text">Bechdel Test</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../data-viz/national-parks.html">
 <span class="dropdown-text">National Parks</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../data-viz/national-park-interactive.html">
 <span class="dropdown-text">National Parks - Interactive</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../data-viz/simulation.html">
 <span class="dropdown-text">Simulation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../data-viz/ethics.html">
 <span class="dropdown-text">Data Ethics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../data-viz/Project_5.html">
 <span class="dropdown-text">SQL Analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../data-viz/text-analysis.html">
 <span class="dropdown-text">Full Text Analysis</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#data-values-and-principles-manifesto" id="toc-data-values-and-principles-manifesto" class="nav-link" data-scroll-target="#data-values-and-principles-manifesto">Data Values and Principles Manifesto</a></li>
  <li><a href="#what-was-the-consent-structure" id="toc-what-was-the-consent-structure" class="nav-link" data-scroll-target="#what-was-the-consent-structure">What was the consent structure?</a></li>
  <li><a href="#were-the-data-made-publicly-available" id="toc-were-the-data-made-publicly-available" class="nav-link" data-scroll-target="#were-the-data-made-publicly-available">Were the data made publicly available?</a></li>
  <li><a href="#who-was-measured-are-the-representative-of-whom-we-want-to-generalize" id="toc-who-was-measured-are-the-representative-of-whom-we-want-to-generalize" class="nav-link" data-scroll-target="#who-was-measured-are-the-representative-of-whom-we-want-to-generalize">Who was measured? Are the representative of whom we want to generalize?</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li><a href="#sources" id="toc-sources" class="nav-link" data-scroll-target="#sources">Sources:</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-page-left" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Ethics in Data Science</h1>
</div>



<div class="quarto-title-meta column-page-left">

    
  
    
  </div>
  


</header>


<section id="case-study-targets-pregnancy-predicting-algorithm" class="level5">
<h5 class="anchored" data-anchor-id="case-study-targets-pregnancy-predicting-algorithm">Case Study: Target’s pregnancy predicting algorithm</h5>
<p>Target is a retail corporation and one of the nation’s biggest department store chains. They offer a wide variety of goods from groceries, to clothing, to baby products. In 2012, an article in the New York Times titled “<em>How Companies Learn Your Secrets</em>” by Charles Duhigg exposed the company’s “pregnancy predictor” algorithm. The algorithm, created by statistician Andrew Pole, uses customers’ shopping habits to predict if they are pregnant, with the goal of targeting advertising to increase sales and build customer loyalty. By predicting whether an individual is pregnant, Target can advertise baby products to them before the child is born and influence their shopping habits. This algorithm took data from customers, often without their knowledge or consent, and used it to benefit the company without the consumer knowing what was going on</p>
</section>
<section id="background" class="level3">
<h3 class="anchored" data-anchor-id="background">Background</h3>
<p>Andrew Pole was hired by Target to use his insights into consumer habits to increase Target’s sales. He was tasked with identifying the moments in consumers’ lives where they are undergoing great changes and so their shopping habits were also susceptible to change. One such period was the time around the birth of a child. Target wanted to reach new parents before other brands could, which led them to want to know if their customers were pregnant, even if they didn’t want the brand to know.</p>
<p>Pole began by looking at baby shower registries, where pregnant people willingly disclosed their pregnancy. He observed how these people’s spending habits changed as they approached their due date. One of the trends he noticed was that many people began to buy lots of unscented lotion around the beginning of their second trimester and an increase in vitamins in their first trimester. Through all of this data, Pole developed a list of 25 products that allowed him to give each consumer a “pregnancy prediction” score, as well as an estimate of their due date. This would then allow Target to send the customer specialized ads for relevant products as they approached their due date. Target also used information about habit building to increase the variety of products that consumers would purchase.</p>
<p>Pole then applied this algorithm to every regular female shopper in the nation and produced a list of thousands of people who it found were most likely pregnant. While this is not illegal—Target says they comply with all federal and state laws—and it isn’t a case of leaked or stolen data, this story still spurs ethical questions related to data collection and use. Some of the ethical concerns that this raises are: Who benefits from the use of this data and who suffers? Should it be possible for brands to predict sensitive health information? What should they be able to do with this information?</p>
</section>
<section id="data-values-and-principles-manifesto" class="level3">
<h3 class="anchored" data-anchor-id="data-values-and-principles-manifesto">Data Values and Principles Manifesto</h3>
<p>The first item in the Data Values and Principles Manifesto states, “Use data to improve life for our users, customers, organizations, and communities.” This raises the question of whose life is really improved by this algorithm. Target might claim that the algorithm can actually be beneficial to pregnant people. By providing them with advertisements and coupons it makes it easier for customers to get the products they need and even save money.</p>
<p>As described in the New York Times article, new parents are often overwhelmed and they no longer want to shop at different stores for different items. By advertising the diversity of Target’s products, they made it easier for parents to get everything they need from one store.</p>
<p>In the article, “Target Knows You’re Pregnant; Is This What Customers Really Want,” Brian Cantor makes the argument that consumers like when ads are targeted toward their preferences and needs and that it makes shopping a better experience for them.</p>
<p>However, I don’t think this is actually improving the lives of users. Advertising is one thing, but using data to predict sensitive information about someone under the guise of benefiting them is different. In reality, Target, as a corporation, benefits from this algorithm.</p>
<p>Additionally, while Target might claim that this information is purely for advertising purposes, when placed in the wrong hands, information about a person’s reproductive status can have detrimental effects on their life. In the book Predictive Analytics by Eric Siegel, he cites an online user who explained the scenario of a pregnant woman with a precarious job, struggling to get state disability—if this woman’s pregnancy was leaked, she could risk losing her benefits and her job.</p>
<p>Especially in a post-Roe v. Wade society, reproductive information is extremely sensitive and the pregnant person should have full control over who knows that information. While this data increases Target’s profits and could benefit customers, it also has the potential to harm many people.</p>
</section>
<section id="what-was-the-consent-structure" class="level3">
<h3 class="anchored" data-anchor-id="what-was-the-consent-structure">What was the consent structure?</h3>
<p>The data being used came from baby registries, purchase history, and customer profiles. Customers making baby registries willingly provided their status and due date, and customers in the store technically agreed to Target knowing their purchase history. However, the “participants” whose data was being used were not aware of exactly the applications of their data.</p>
<p>Customers that have Target accounts or loyalty cards accept certain terms and conditions that are usually long and hard to understand. Technically, this is customers giving their consent to their data being used. Customers were not aware that their data would be used to create a predictive model that could reveal sensitive health information.</p>
<p>This creates the question of: Can you provide informed consent for applications that are not yet foreseen? Target customers could never have known what their data would be used for, and it is virtually impossible to ever give consent for future applications that are unknown. To some extent, that’s a risk we take in the digital age. However, I think that even if participants have given “consent,” companies should be prevented from manipulating that “consent” in ethically ambiguous ways.</p>
</section>
<section id="were-the-data-made-publicly-available" class="level3">
<h3 class="anchored" data-anchor-id="were-the-data-made-publicly-available">Were the data made publicly available?</h3>
<p>The algorithm that Pole created and the data about individuals’ “pregnancy scores” has not become publicly available. In this case, it is crucial to the privacy, autonomy, and well-being of Target customers that this data remains non-public. However, it is important to keep in mind that “non-public” does not mean private. Target could be selling this data to other companies so it is impossible to know who actually has access to this data and what they are using it for. Additionally, there could be some benefit to making the algorithm or anonymous data public so that the data science community can check for bias and keep Target accountable for their actions.</p>
</section>
<section id="who-was-measured-are-the-representative-of-whom-we-want-to-generalize" class="level3">
<h3 class="anchored" data-anchor-id="who-was-measured-are-the-representative-of-whom-we-want-to-generalize">Who was measured? Are the representative of whom we want to generalize?</h3>
<p>One thing that should be considered when discussing ethics in data is representation in the data and who we are generalizing to. In this case, the individuals measured were regular Target shoppers who used loyalty cards or credit cards. While this is not representative of the whole population and is likely skewed by demographics like income, age, and race, it may not be as big of a concern in this case. Target is applying their algorithm to other target shoppers in which case the data is representative of the populations we are generalizing to.</p>
</section>
<section id="conclusion" class="level3">
<h3 class="anchored" data-anchor-id="conclusion">Conclusion</h3>
<p>In conclusion, Targets “pregnancy predictor” raises many ethical questions surrounding data use and corporations use of data to predict sensitive health information about their customers. Working in the field of data science requires critical examination of our biases and consideration of ethical issues surrounding data.</p>
</section>
<section id="sources" class="level3">
<h3 class="anchored" data-anchor-id="sources">Sources:</h3>
<p>Duhigg, Charles. “How Companies Learn Your Secrets.” The New York Times Magazine, 16 Feb.&nbsp;2012, www.nytimes.com/2012/02/19/magazine/shopping-habits.html.</p>
<p>Cantor, Brian. “Target Knows You’re Pregnant; Is This What Customers Really Want?” Customer Contact Week Digital, www.customercontactweekdigital.com/customer-experience/articles/target-knows-you-re-pregnant-is-this-what-customer. Accessed 16 Apr.&nbsp;2025.</p>
<p>Siegel, Eric. Predictive Analytics: The Power to Predict Who Will Click, Buy, Lie, or Die. Revised and Updated ed., Wiley, 2016.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>